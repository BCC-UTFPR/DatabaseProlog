#lang web-server

(require web-server/dispatch)
(require xml net/url)
(require web-server/http)
(require web-server/servlet-env)

;regra de despacho para determinados tipos de URL
;http://docs.racket-lang.org/web-server/dispatch.html
(define-values (servidor servidor-url)
    (dispatch-rules
     [("") main]
     [("fatorial" (integer-arg)) chamada-fatorial]
     [else main]))

#|cada URL diferente deve-se criar um formato de HTML para que apareça na página.
Esta primeira é main que sempre irá ser executado na primeira vez, pode se dizer que é a URL raiz |#
(define (main req) (response/xexpr `(html (head (title "Trabalho de LP"))
                                      (body (p, "Para utilizar o servidor utilize a url http://localhost:8080/funcao/parametros"))                                
                                      (body (b, "As funções que tem são:"))
                                      (body (p, "fatorial")))))
                                      
;FATORIAL
(define (chamada-fatorial req fat) (response/xexpr `(html (head (title "Trabalho de LP"))
                                      (body (p, "Execução da função fatorial com o(s) parâmetro(s) ", (number->string fat) ".")
                                            (p, "Resultado: ",(number->string(fatorial fat)))))))

;função de chamada externa para fatorial
(define (fatorial fat) (define resultado 
                            (string-split 
                             (with-output-to-string 
                              (lambda() (system (string-append "racket /home/jfilhogn/Documentos/LP/LPserver/apps/fatorial.rkt " (number->string fat))))) "\n")) 
                              (string->number (first resultado)))


(serve/servlet servidor
               #:port 8080
               #:servlet-regexp #rx".*"
               #:servlet-path "/")
